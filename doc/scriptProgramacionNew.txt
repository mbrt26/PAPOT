

-- OPERACION ACTUAL + ANTERIOR
SELECT  tblDctosOrdenesDetalle.idLocalOrigen
         ,tblDctosOrdenesDetalle.idTipoOrdenOrigen
         ,tblDctosOrdenesDetalle.idOrdenOrigen
         ,tblDctosOrdenesDetalle.itemPadre
         ,tblDctosOrdenesDetalle.idOperacion 
                              AS idOperacionAnterior
         ,00 AS idOperacionActual
         ,SUM(tblDctosOrdenesDetalle.pesoTerminado)
                                    AS pesoTerminado
         ,SUM(tblDctosOrdenesDetalle.cantidadTerminada)
                                   AS cantidadTerminada
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idOrdenOrigen = 7707
AND   tblDctosOrdenesDetalle.idOperacion   = 5
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      > 0
GROUP BY tblDctosOrdenesDetalle.idLocalOrigen
        ,tblDctosOrdenesDetalle.idTipoOrdenOrigen
        ,tblDctosOrdenesDetalle.idOrdenOrigen
        ,tblDctosOrdenesDetalle.itemPadre
        ,tblDctosOrdenesDetalle.idOperacion 
UNION 
SELECT  tblDctosOrdenesDetalle.idLocalOrigen
         ,tblDctosOrdenesDetalle.idTipoOrdenOrigen
         ,tblDctosOrdenesDetalle.idOrdenOrigen
         ,tblDctosOrdenesDetalle.itemPadre
         ,00 AS idOperacionAnterior
         ,tblDctosOrdenesDetalle.idOperacion AS 
                                      idOperacionActual
         ,SUM(tblDctosOrdenesDetalle.pesoTerminado)
                                    AS pesoTerminado
         ,SUM(tblDctosOrdenesDetalle.cantidadTerminada)
                                   AS cantidadTerminada
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idOrdenOrigen = 7707
AND   tblDctosOrdenesDetalle.idOperacion   = 6
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      > 0
GROUP BY tblDctosOrdenesDetalle.idLocalOrigen
        ,tblDctosOrdenesDetalle.idTipoOrdenOrigen
        ,tblDctosOrdenesDetalle.idOrdenOrigen
        ,tblDctosOrdenesDetalle.itemPadre
        ,tblDctosOrdenesDetalle.idOperacion    

-- ORDEN COMPLETA
SELECT tblDctosOrdenes.idLocal,
       tblDctosOrdenes.idTipoOrden,
       tblDctosOrdenes.idOrden,
       tblDctosOrdenesDetalle.itemPadre,
       tblDctosOrdenes.idCliente,
       tblDctosOrdenes.numeroOrden,
       tblDctosOrdenes.idFicha,
       tblDctosOrdenesDetalle.fechaEntrega
FROM   tblDctosOrdenes
INNER JOIN (
SELECT tblPlusFicha.idFicha, 
       MAX(tblPlusFicha.referencia)         
                     AS referencia, 
       MAX(tblJobOperacion.nombreOperacion) 
                        AS nombreOperacion, 
       MAX(tblPlusFicha.referenciaCliente) 
                      AS referenciaCliente, 
       MAX(tblPlusFicha.nombreReferencia) 
                       AS nombreReferencia, 
       tblJobEscalaDetalle.nombreItem
FROM   tblPlusFicha
INNER JOIN tblJobOperacion
ON tblPlusFicha.idOperacion      = 
              tblJobOperacion.idOperacion
INNER JOIN tblJobEscalaDetalle
ON tblPlusFicha.idEscala         = 
             tblJobEscalaDetalle.idEscala
AND tblPlusFicha.vrEscala        = 
                 tblJobEscalaDetalle.item
WHERE  (tblPlusFicha.idOperacion = 2)
AND tblPlusFicha.idEscala 
                 IN (600, 710, 910, 1000)
AND tblPlusFicha.vrEscala        = 7
GROUP BY tblPlusFicha.idFicha, 
         tblJobEscalaDetalle.nombreItem)
                               AS tmpFIC
ON tblDctosOrdenes.idFicha  = 
                          tmpFIC.idFicha
INNER JOIN tblDctosOrdenesDetalle
ON tblDctosOrdenesDetalle.idLocal     = 
                       tblDctosOrdenes.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrden = 
                   tblDctosOrdenes.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrden     = 
                     tblDctosOrdenes.idOrden
WHERE tblDctosOrdenes.idLocal            = 1
AND   tblDctosOrdenes.idTipoOrden        = 59
AND   tblDctosOrdenes.numeroOrden        > 0
AND   tblDctosOrdenes.idOrden            = 7707


---
SELECT tblDctosOrdenes.idLocal,
       tblDctosOrdenes.idTipoOrden,
       tblDctosOrdenes.idOrden,
       tblDctosOrdenesDetalle.itemPadre,
       tblDctosOrdenes.idCliente,
       tblDctosOrdenes.numeroOrden,
       tblDctosOrdenes.idFicha,
       tblDctosOrdenesDetalle.fechaEntrega
FROM   tblDctosOrdenes
INNER JOIN (
SELECT tblPlusFicha.idFicha, 
       MAX(tblPlusFicha.referencia)         
                     AS referencia, 
       MAX(tblJobOperacion.nombreOperacion) 
                        AS nombreOperacion, 
       MAX(tblPlusFicha.referenciaCliente) 
                      AS referenciaCliente, 
       MAX(tblPlusFicha.nombreReferencia) 
                       AS nombreReferencia, 
       tblJobEscalaDetalle.nombreItem
FROM   tblPlusFicha
INNER JOIN tblJobOperacion
ON tblPlusFicha.idOperacion      = 
              tblJobOperacion.idOperacion
INNER JOIN tblJobEscalaDetalle
ON tblPlusFicha.idEscala         = 
             tblJobEscalaDetalle.idEscala
AND tblPlusFicha.vrEscala        = 
                 tblJobEscalaDetalle.item
WHERE  (tblPlusFicha.idOperacion = 2)
AND tblPlusFicha.idEscala 
                 IN (600, 710, 910, 1000)
AND tblPlusFicha.vrEscala        = 7
GROUP BY tblPlusFicha.idFicha, 
         tblJobEscalaDetalle.nombreItem)
                               AS tmpFIC
ON tblDctosOrdenes.idFicha  = 
                          tmpFIC.idFicha
INNER JOIN tblDctosOrdenesDetalle
ON tblDctosOrdenesDetalle.idLocal     = 
                       tblDctosOrdenes.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrden = 
                   tblDctosOrdenes.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrden     = 
                     tblDctosOrdenes.idOrden
WHERE tblDctosOrdenes.idLocal            = 1
AND   tblDctosOrdenes.idTipoOrden        = 59
AND   tblDctosOrdenes.numeroOrden        > 0
--AND   tblDctosOrdenes.idOrden            = 7707


--- OPERACION PEDIDOS = 1
SELECT tblDctosOrdenesDetalle.idLocal
                        AS idLocalOrigen
      ,tblDctosOrdenesDetalle.idTipoOrden
                     AS idTipoOrdenOrigen
      ,tblDctosOrdenesDetalle.idOrden
                     AS idOrdenOrigen
      ,tblDctosOrdenesDetalle.itemPadre
      ,1 AS idOperacion
      ,tblDctosOrdenesDetalle.cantidad
          AS cantidadTerminada
      ,tblDctosOrdenesDetalle.pesoPedido 
                        AS pesoTerminado
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idLocal     = 1
AND   tblDctosOrdenesDetalle.idTipoOrden = 59

---
                SELECT TOP 1 tblPlusFicha.idOperacion           
                FROM   tblPlusFicha                           
                INNER JOIN tblJobOperacion                    
                ON tblPlusFicha.idOperacion =                 
                        tblJobOperacion.idOperacion           
                WHERE   tblPlusFicha.idFicha = 2423                
                AND tblPlusFicha.idEscala    =  610 (FIJO-610)
                AND tblPlusFicha.vrEscala    =    2 (OPERACION)
                
--                
SELECT tblDctosOrdenes.idLocal,                     
         tblDctosOrdenes.idTipoOrden,              
         tblDctosOrdenes.idOrden,                  
         tblDctosOrdenesDetalle.itemPadre,         
         tblDctosOrdenes.idCliente,                
         tblDctosOrdenes.numeroOrden,              
         tblDctosOrdenes.idFicha,                  
         tblDctosOrdenesDetalle.fechaEntrega,      
         tmpFIC.referencia,                        
         tmpFIC.nombreOperacion,                   
         tmpFIC.referenciaCliente,                 
         tmpFIC.nombreReferencia,                  
         tmpFIC.nombreItem,                        
         tblTerceros.nombreTercero,                
        (SELECT TOP 1 tblPlusFicha.idOperacion     
        FROM   tblPlusFicha                        
        INNER JOIN tblJobOperacion                 
        ON tblPlusFicha.idOperacion =              
                 tblJobOperacion.idOperacion       
        WHERE   tblPlusFicha.idFicha =             
                    tblDctosOrdenes.idFicha        
        AND tblPlusFicha.idEscala    =  610        
        AND tblPlusFicha.vrEscala    =  2 )                             
                       AS idOperacionAnterior,
        tmpFIC.idOperacion
  FROM   tblDctosOrdenes                           
  INNER JOIN tblTerceros                           
  ON  tblTerceros.idCliente =                      
                      tblDctosOrdenes.idCliente    
  INNER JOIN (                                     
  SELECT tblPlusFicha.idFicha,                     
         MAX(tblPlusFicha.referencia)              
                       AS referencia,              
         MAX(tblJobOperacion.nombreOperacion)      
                          AS nombreOperacion,      
         MAX(tblPlusFicha.referenciaCliente)       
                        AS referenciaCliente,      
         MAX(tblPlusFicha.nombreReferencia)        
                         AS nombreReferencia,      
         tblJobEscalaDetalle.nombreItem,
         tblPlusFicha.idOperacion   
  FROM   tblPlusFicha                              
  INNER JOIN tblJobOperacion                       
  ON tblPlusFicha.idOperacion      =               
                tblJobOperacion.idOperacion        
  INNER JOIN tblJobEscalaDetalle                   
  ON tblPlusFicha.idEscala         =               
               tblJobEscalaDetalle.idEscala        
  AND tblPlusFicha.vrEscala        =               
                   tblJobEscalaDetalle.item        
  WHERE   tblPlusFicha.idOperacion = 2              
  AND tblPlusFicha.idEscala                        
                   IN (600, 710, 910, 1000)        
  AND tblPlusFicha.vrEscala        =  7             
  GROUP BY tblPlusFicha.idFicha,                   
           tblPlusFicha.idOperacion,
           tblJobEscalaDetalle.nombreItem)         
                                 AS tmpFIC         
  ON tblDctosOrdenes.idFicha  =                    
                            tmpFIC.idFicha         
  INNER JOIN tblDctosOrdenesDetalle                
  ON tblDctosOrdenesDetalle.idLocal     =          
                         tblDctosOrdenes.idLocal   
  AND   tblDctosOrdenesDetalle.idTipoOrden =       
                     tblDctosOrdenes.idTipoOrden   
  AND   tblDctosOrdenesDetalle.idOrden     =       
                       tblDctosOrdenes.idOrden     
  WHERE tblDctosOrdenes.idLocal            = 1      
  AND   tblDctosOrdenes.idTipoOrden        = 59      
  AND   tblDctosOrdenes.numeroOrden        > 0     
  AND   tblTerceros.idTipoTercero          = 1     
  ORDER BY tblDctosOrdenesDetalle.fechaEntrega,    
           tblDctosOrdenes.numeroOrden             ;
           
--- **** CASI
SELECT tmpPED.*,
( SELECT SUM(tblDctosOrdenesDetalle.pesoTerminado)
                                    AS pesoTerminado
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idLocalOrigen     = tmpPED.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = tmpPED.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrdenOrigen     = tmpPED.idOrden
AND   tblDctosOrdenesDetalle.itemPadre         = tmpPED.itemPadre
AND   tblDctosOrdenesDetalle.idOperacion       = tmpPED.idOperacion
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      < 0 ) AS pesoTerminado
FROM (

 SELECT tblDctosOrdenes.idLocal,                     
        tblDctosOrdenes.idTipoOrden,              
        tblDctosOrdenes.idOrden,                  
        tblDctosOrdenesDetalle.itemPadre,         
        tblDctosOrdenes.idCliente,                
        tblDctosOrdenes.numeroOrden,              
        tblDctosOrdenes.idFicha,                  
        tblDctosOrdenesDetalle.fechaEntrega,      
        tmpFIC.referencia,                        
        tmpFIC.nombreOperacion,                   
        tmpFIC.referenciaCliente,                 
        tmpFIC.nombreReferencia,                  
        tmpFIC.nombreItem,                        
        tblTerceros.nombreTercero,                
        (SELECT TOP 1 tblPlusFicha.idOperacion     
        FROM   tblPlusFicha                        
        INNER JOIN tblJobOperacion                 
        ON tblPlusFicha.idOperacion =              
                 tblJobOperacion.idOperacion       
        WHERE   tblPlusFicha.idFicha =             
                    tblDctosOrdenes.idFicha        
        AND tblPlusFicha.idEscala    =  610        
        AND tblPlusFicha.vrEscala    =  2 )                             
                       AS idOperacionAnterior,
        tmpFIC.idOperacion
  FROM   tblDctosOrdenes                           
  INNER JOIN tblTerceros                           
  ON  tblTerceros.idCliente =                      
                      tblDctosOrdenes.idCliente    
  INNER JOIN (                                     
  SELECT tblPlusFicha.idFicha,                     
         MAX(tblPlusFicha.referencia)              
                       AS referencia,              
         MAX(tblJobOperacion.nombreOperacion)      
                          AS nombreOperacion,      
         MAX(tblPlusFicha.referenciaCliente)       
                        AS referenciaCliente,      
         MAX(tblPlusFicha.nombreReferencia)        
                         AS nombreReferencia,      
         tblJobEscalaDetalle.nombreItem,
         tblPlusFicha.idOperacion   
  FROM   tblPlusFicha                              
  INNER JOIN tblJobOperacion                       
  ON tblPlusFicha.idOperacion      =               
                tblJobOperacion.idOperacion        
  INNER JOIN tblJobEscalaDetalle                   
  ON tblPlusFicha.idEscala         =               
               tblJobEscalaDetalle.idEscala        
  AND tblPlusFicha.vrEscala        =               
                   tblJobEscalaDetalle.item        
  WHERE   tblPlusFicha.idOperacion = 2              
  AND tblPlusFicha.idEscala                        
                   IN (600, 710, 910, 1000)        
  AND tblPlusFicha.vrEscala        =  7             
  GROUP BY tblPlusFicha.idFicha,                   
           tblPlusFicha.idOperacion,
           tblJobEscalaDetalle.nombreItem)         
                                 AS tmpFIC         
  ON tblDctosOrdenes.idFicha  =                    
                            tmpFIC.idFicha         
  INNER JOIN tblDctosOrdenesDetalle                
  ON tblDctosOrdenesDetalle.idLocal     =          
                         tblDctosOrdenes.idLocal   
  AND   tblDctosOrdenesDetalle.idTipoOrden =       
                     tblDctosOrdenes.idTipoOrden   
  AND   tblDctosOrdenesDetalle.idOrden     =       
                       tblDctosOrdenes.idOrden     
  WHERE tblDctosOrdenes.idLocal            = 1      
  AND   tblDctosOrdenes.idTipoOrden        = 59      
  AND   tblDctosOrdenes.numeroOrden        > 0     
  AND   tblTerceros.idTipoTercero          = 1 ) 
                                       AS tmpPED
                                       
                                       
--- **** CASI **
SELECT tmpPED.*,
( SELECT SUM(tblDctosOrdenesDetalle.pesoTerminado)
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idLocalOrigen     = tmpPED.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = tmpPED.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrdenOrigen     = tmpPED.idOrden
AND   tblDctosOrdenesDetalle.itemPadre         = tmpPED.itemPadre
AND   tblDctosOrdenesDetalle.idOperacion       = tmpPED.idOperacion
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      < 0 ) AS pesoTerminado,
( SELECT SUM(tblDctosOrdenesDetalle.cantidadTerminada)
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idLocalOrigen     = tmpPED.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = tmpPED.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrdenOrigen     = tmpPED.idOrden
AND   tblDctosOrdenesDetalle.itemPadre         = tmpPED.itemPadre
AND   tblDctosOrdenesDetalle.idOperacion       = tmpPED.idOperacion
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      < 0 ) AS cantidadTerminada
FROM (

 SELECT tblDctosOrdenes.idLocal,                     
        tblDctosOrdenes.idTipoOrden,              
        tblDctosOrdenes.idOrden,                  
        tblDctosOrdenesDetalle.itemPadre,         
        tblDctosOrdenes.idCliente,                
        tblDctosOrdenes.numeroOrden,              
        tblDctosOrdenes.idFicha,                  
        tblDctosOrdenesDetalle.fechaEntrega,      
        tmpFIC.referencia,                        
        tmpFIC.nombreOperacion,                   
        tmpFIC.referenciaCliente,                 
        tmpFIC.nombreReferencia,                  
        tmpFIC.nombreItem,                        
        tblTerceros.nombreTercero,                
        (SELECT TOP 1 tblPlusFicha.idOperacion     
        FROM   tblPlusFicha                        
        INNER JOIN tblJobOperacion                 
        ON tblPlusFicha.idOperacion =              
                 tblJobOperacion.idOperacion       
        WHERE   tblPlusFicha.idFicha =             
                    tblDctosOrdenes.idFicha        
        AND tblPlusFicha.idEscala    =  610        
        AND tblPlusFicha.vrEscala    =  2 )                             
                       AS idOperacionAnterior,
        tmpFIC.idOperacion
  FROM   tblDctosOrdenes                           
  INNER JOIN tblTerceros                           
  ON  tblTerceros.idCliente =                      
                      tblDctosOrdenes.idCliente    
  INNER JOIN (                                     
  SELECT tblPlusFicha.idFicha,                     
         MAX(tblPlusFicha.referencia)              
                       AS referencia,              
         MAX(tblJobOperacion.nombreOperacion)      
                          AS nombreOperacion,      
         MAX(tblPlusFicha.referenciaCliente)       
                        AS referenciaCliente,      
         MAX(tblPlusFicha.nombreReferencia)        
                         AS nombreReferencia,      
         tblJobEscalaDetalle.nombreItem,
         tblPlusFicha.idOperacion   
  FROM   tblPlusFicha                              
  INNER JOIN tblJobOperacion                       
  ON tblPlusFicha.idOperacion      =               
                tblJobOperacion.idOperacion        
  INNER JOIN tblJobEscalaDetalle                   
  ON tblPlusFicha.idEscala         =               
               tblJobEscalaDetalle.idEscala        
  AND tblPlusFicha.vrEscala        =               
                   tblJobEscalaDetalle.item        
  WHERE   tblPlusFicha.idOperacion = 2              
  AND tblPlusFicha.idEscala                        
                   IN (600, 710, 910, 1000)        
  AND tblPlusFicha.vrEscala        =  7             
  GROUP BY tblPlusFicha.idFicha,                   
           tblPlusFicha.idOperacion,
           tblJobEscalaDetalle.nombreItem)         
                                 AS tmpFIC         
  ON tblDctosOrdenes.idFicha  =                    
                            tmpFIC.idFicha         
  INNER JOIN tblDctosOrdenesDetalle                
  ON tblDctosOrdenesDetalle.idLocal     =          
                         tblDctosOrdenes.idLocal   
  AND   tblDctosOrdenesDetalle.idTipoOrden =       
                     tblDctosOrdenes.idTipoOrden   
  AND   tblDctosOrdenesDetalle.idOrden     =       
                       tblDctosOrdenes.idOrden     
  WHERE tblDctosOrdenes.idLocal            = 1      
  AND   tblDctosOrdenes.idTipoOrden        = 59      
  AND   tblDctosOrdenes.numeroOrden        > 0     
  AND   tblTerceros.idTipoTercero          = 1 ) 
                                       AS tmpPED
                                       
---
SELECT tmpPED.*,
( SELECT SUM(tblDctosOrdenesDetalle.pesoTerminado)
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idLocalOrigen     = 
                                   tmpPED.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                               tmpPED.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrdenOrigen     = 
                                   tmpPED.idOrden
AND   tblDctosOrdenesDetalle.itemPadre         = 
                                 tmpPED.itemPadre
AND   tblDctosOrdenesDetalle.idOperacion       = 
                       tmpPED.idOperacionAnterior
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      < 0 ) 
                       AS pesoTerminadoAnterior,
( SELECT 
    SUM(tblDctosOrdenesDetalle.cantidadTerminada)
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idLocalOrigen     = 
                                   tmpPED.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                               tmpPED.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrdenOrigen     = 
                                   tmpPED.idOrden
AND   tblDctosOrdenesDetalle.itemPadre         = 
                                 tmpPED.itemPadre
AND   tblDctosOrdenesDetalle.idOperacion       = 
                       tmpPED.idOperacionAnterior
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      < 0 ) 
                    AS cantidadTerminadaAnterior,
( SELECT SUM(tblDctosOrdenesDetalle.pesoTerminado)
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idLocalOrigen     = 
                                    tmpPED.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                                tmpPED.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrdenOrigen     = 
                                    tmpPED.idOrden
AND   tblDctosOrdenesDetalle.itemPadre         = 
                                  tmpPED.itemPadre
AND   tblDctosOrdenesDetalle.idOperacion       = 
                                tmpPED.idOperacion
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      < 0 ) 
                            AS pesoTerminadoActual,
( SELECT 
     SUM(tblDctosOrdenesDetalle.cantidadTerminada)
FROM tblDctosOrdenesDetalle
WHERE tblDctosOrdenesDetalle.idLocalOrigen     = 
                                    tmpPED.idLocal
AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                                tmpPED.idTipoOrden
AND   tblDctosOrdenesDetalle.idOrdenOrigen     = 
                                    tmpPED.idOrden
AND   tblDctosOrdenesDetalle.itemPadre         = 
                                  tmpPED.itemPadre
AND   tblDctosOrdenesDetalle.idOperacion       = 
                                tmpPED.idOperacion
AND   tblDctosOrdenesDetalle.idPlu         = 209
AND   tblDctosOrdenesDetalle.cantidad      < 0 ) 
                       AS cantidadTerminadaActual
FROM (
 SELECT tblDctosOrdenes.idLocal,                     
        tblDctosOrdenes.idTipoOrden,              
        tblDctosOrdenes.idOrden,                  
        tblDctosOrdenesDetalle.itemPadre,         
        tblDctosOrdenes.idCliente,                
        tblDctosOrdenes.numeroOrden,              
        tblDctosOrdenes.idFicha,                  
        tblDctosOrdenesDetalle.fechaEntrega,      
        tmpFIC.referencia,                        
        tmpFIC.nombreOperacion,                   
        tmpFIC.referenciaCliente,                 
        tmpFIC.nombreReferencia,                  
        tmpFIC.nombreItem,                        
        tblTerceros.nombreTercero,                
        (SELECT TOP 1 tblPlusFicha.idOperacion     
        FROM   tblPlusFicha                        
        INNER JOIN tblJobOperacion                 
        ON tblPlusFicha.idOperacion =              
                 tblJobOperacion.idOperacion       
        WHERE   tblPlusFicha.idFicha =             
                    tblDctosOrdenes.idFicha        
        AND tblPlusFicha.idEscala    =  610        
        AND tblPlusFicha.vrEscala    =  2 )                             
                       AS idOperacionAnterior,
        tmpFIC.idOperacion
  FROM   tblDctosOrdenes                           
  INNER JOIN tblTerceros                           
  ON  tblTerceros.idCliente =                      
                      tblDctosOrdenes.idCliente    
  INNER JOIN (                                     
  SELECT tblPlusFicha.idFicha,                     
         MAX(tblPlusFicha.referencia)              
                       AS referencia,              
         MAX(tblJobOperacion.nombreOperacion)      
                          AS nombreOperacion,      
         MAX(tblPlusFicha.referenciaCliente)       
                        AS referenciaCliente,      
         MAX(tblPlusFicha.nombreReferencia)        
                         AS nombreReferencia,      
         tblJobEscalaDetalle.nombreItem,
         tblPlusFicha.idOperacion   
  FROM   tblPlusFicha                              
  INNER JOIN tblJobOperacion                       
  ON tblPlusFicha.idOperacion      =               
                tblJobOperacion.idOperacion        
  INNER JOIN tblJobEscalaDetalle                   
  ON tblPlusFicha.idEscala         =               
               tblJobEscalaDetalle.idEscala        
  AND tblPlusFicha.vrEscala        =               
                   tblJobEscalaDetalle.item        
  WHERE   tblPlusFicha.idOperacion = 2              
  AND tblPlusFicha.idEscala                        
                   IN (600, 710, 910, 1000)        
  AND tblPlusFicha.vrEscala        =  7             
  GROUP BY tblPlusFicha.idFicha,                   
           tblPlusFicha.idOperacion,
           tblJobEscalaDetalle.nombreItem)         
                                 AS tmpFIC         
  ON tblDctosOrdenes.idFicha  =                    
                            tmpFIC.idFicha         
  INNER JOIN tblDctosOrdenesDetalle                
  ON tblDctosOrdenesDetalle.idLocal     =          
                         tblDctosOrdenes.idLocal   
  AND   tblDctosOrdenesDetalle.idTipoOrden =       
                     tblDctosOrdenes.idTipoOrden   
  AND   tblDctosOrdenesDetalle.idOrden     =       
                       tblDctosOrdenes.idOrden     
  WHERE tblDctosOrdenes.idLocal            = 1      
  AND   tblDctosOrdenes.idTipoOrden        = 59      
  AND   tblDctosOrdenes.numeroOrden        > 0     
  AND   tblTerceros.idTipoTercero          = 1 ) 
                                       AS tmpPED
  
  
  --
  SELECT tmpPEN.idLocal,
         tmpPEN.idTipoOrden,
         tmpPEN.idOrden,
         tmpPEN.itemPadre,
         tmpPEN.idCliente,
         tmpPEN.numeroOrden,
         tmpPEN.idFicha,
         tmpPEN.fechaEntrega,
         tmpPEN.referencia,
         tmpPEN.nombreOperacion,
         tmpPEN.referenciaCliente,       
         tmpPEN.nombreReferencia,       
         tmpPEN.nombreItem,       
         tmpPEN.nombreTercero,       
         tmpPEN.idOperacionAnterior,       
         tmpPEN.idOperacion
  FROM (
  SELECT tmpPED.*,
  ( SELECT SUM(tblDctosOrdenesDetalle.pesoTerminado)
  FROM tblDctosOrdenesDetalle
  WHERE tblDctosOrdenesDetalle.idLocalOrigen     = 
                                     tmpPED.idLocal
  AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                                 tmpPED.idTipoOrden
  AND   tblDctosOrdenesDetalle.idOrdenOrigen     = 
                                     tmpPED.idOrden
  AND   tblDctosOrdenesDetalle.itemPadre         = 
                                   tmpPED.itemPadre
  AND   tblDctosOrdenesDetalle.idOperacion       = 
                         tmpPED.idOperacionAnterior
  AND   tblDctosOrdenesDetalle.idPlu         = 209
  AND   tblDctosOrdenesDetalle.cantidad      < 0 ) 
                         AS pesoTerminadoAnterior,
  ( SELECT 
      SUM(tblDctosOrdenesDetalle.cantidadTerminada)
  FROM tblDctosOrdenesDetalle
  WHERE tblDctosOrdenesDetalle.idLocalOrigen     = 
                                     tmpPED.idLocal
  AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                                 tmpPED.idTipoOrden
  AND   tblDctosOrdenesDetalle.idOrdenOrigen     = 
                                     tmpPED.idOrden
  AND   tblDctosOrdenesDetalle.itemPadre         = 
                                   tmpPED.itemPadre
  AND   tblDctosOrdenesDetalle.idOperacion       = 
                         tmpPED.idOperacionAnterior
  AND   tblDctosOrdenesDetalle.idPlu         = 209
  AND   tblDctosOrdenesDetalle.cantidad      < 0 ) 
                      AS cantidadTerminadaAnterior,
  ( SELECT SUM(tblDctosOrdenesDetalle.pesoTerminado)
  FROM tblDctosOrdenesDetalle
  WHERE tblDctosOrdenesDetalle.idLocalOrigen     = 
                                      tmpPED.idLocal
  AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                                  tmpPED.idTipoOrden
  AND   tblDctosOrdenesDetalle.idOrdenOrigen     = 
                                      tmpPED.idOrden
  AND   tblDctosOrdenesDetalle.itemPadre         = 
                                    tmpPED.itemPadre
  AND   tblDctosOrdenesDetalle.idOperacion       = 
                                  tmpPED.idOperacion
  AND   tblDctosOrdenesDetalle.idPlu         = 209
  AND   tblDctosOrdenesDetalle.cantidad      < 0 ) 
                              AS pesoTerminadoActual,
  ( SELECT 
       SUM(tblDctosOrdenesDetalle.cantidadTerminada)
  FROM tblDctosOrdenesDetalle
  WHERE tblDctosOrdenesDetalle.idLocalOrigen     = 
                                      tmpPED.idLocal
  AND   tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                                  tmpPED.idTipoOrden
  AND   tblDctosOrdenesDetalle.idOrdenOrigen     = 
                                      tmpPED.idOrden
  AND   tblDctosOrdenesDetalle.itemPadre         = 
                                    tmpPED.itemPadre
  AND   tblDctosOrdenesDetalle.idOperacion       = 
                                  tmpPED.idOperacion
  AND   tblDctosOrdenesDetalle.idPlu         = 209
  AND   tblDctosOrdenesDetalle.cantidad      < 0 ) 
                         AS cantidadTerminadaActual
  FROM (
   SELECT tblDctosOrdenes.idLocal,                     
          tblDctosOrdenes.idTipoOrden,              
          tblDctosOrdenes.idOrden,                  
          tblDctosOrdenesDetalle.itemPadre,         
          tblDctosOrdenes.idCliente,                
          tblDctosOrdenes.numeroOrden,              
          tblDctosOrdenes.idFicha,                  
          tblDctosOrdenesDetalle.fechaEntrega,      
          tblDctosOrdenesDetalle.cantidad 
                            AS cantidadPedida,   
          tblDctosOrdenesDetalle.pesoPedido,   
          tmpFIC.referencia,                        
          tmpFIC.nombreOperacion,                   
          tmpFIC.referenciaCliente,                 
          tmpFIC.nombreReferencia,                  
          tmpFIC.nombreItem,                        
          tblTerceros.nombreTercero,                
          (SELECT TOP 1 tblPlusFicha.idOperacion     
          FROM   tblPlusFicha                        
          INNER JOIN tblJobOperacion                 
          ON tblPlusFicha.idOperacion =              
                   tblJobOperacion.idOperacion       
          WHERE   tblPlusFicha.idFicha =             
                      tblDctosOrdenes.idFicha        
          AND tblPlusFicha.idEscala    =  610        
          AND tblPlusFicha.vrEscala    =  2 )                             
                         AS idOperacionAnterior,
          tmpFIC.idOperacion
    FROM   tblDctosOrdenes                           
    INNER JOIN tblTerceros                           
    ON  tblTerceros.idCliente =                      
                        tblDctosOrdenes.idCliente    
    INNER JOIN (                                     
    SELECT tblPlusFicha.idFicha,                     
           MAX(tblPlusFicha.referencia)              
                         AS referencia,              
           MAX(tblJobOperacion.nombreOperacion)      
                            AS nombreOperacion,      
           MAX(tblPlusFicha.referenciaCliente)       
                          AS referenciaCliente,      
           MAX(tblPlusFicha.nombreReferencia)        
                           AS nombreReferencia,      
           tblJobEscalaDetalle.nombreItem,
           tblPlusFicha.idOperacion   
    FROM   tblPlusFicha                              
    INNER JOIN tblJobOperacion                       
    ON tblPlusFicha.idOperacion      =               
                  tblJobOperacion.idOperacion        
    INNER JOIN tblJobEscalaDetalle                   
    ON tblPlusFicha.idEscala         =               
                 tblJobEscalaDetalle.idEscala        
    AND tblPlusFicha.vrEscala        =               
                     tblJobEscalaDetalle.item        
    WHERE   tblPlusFicha.idOperacion = 2              
    AND tblPlusFicha.idEscala                        
                     IN (600, 710, 910, 1000)        
    AND tblPlusFicha.vrEscala        =  7             
    GROUP BY tblPlusFicha.idFicha,                   
             tblPlusFicha.idOperacion,
             tblJobEscalaDetalle.nombreItem)         
                                   AS tmpFIC         
    ON tblDctosOrdenes.idFicha  =                    
                              tmpFIC.idFicha         
    INNER JOIN tblDctosOrdenesDetalle                
    ON tblDctosOrdenesDetalle.idLocal     =          
                           tblDctosOrdenes.idLocal   
    AND   tblDctosOrdenesDetalle.idTipoOrden =       
                       tblDctosOrdenes.idTipoOrden   
    AND   tblDctosOrdenesDetalle.idOrden     =       
                         tblDctosOrdenes.idOrden     
    WHERE tblDctosOrdenes.idLocal            = 1      
    AND   tblDctosOrdenes.idTipoOrden        = 59      
    AND   tblDctosOrdenes.numeroOrden        > 0     
    AND   tblTerceros.idTipoTercero          = 1 ) 
                                       AS tmpPED )
                                     AS tmpPEN
                                     
--- ACTUALIZAR CANTIDAD + PESO
SELECT tmpPRG.*
FROM 
( SELECT [idLocal]
      ,[idTipoOrden]
      ,[idOrden]
      ,[itemPadre]
      ,[idOperacion]
      ,SUM([cantidadTerminada]) 
          AS cantidadTerminada
      ,SUM([pesoTerminado]) 
              AS pesoTerminado
FROM [tblDctosOrdenesProgreso]
WHERE idOrden = 7771
GROUP BY [idLocal]
      ,[idTipoOrden]
      ,[idOrden]
      ,[itemPadre]
      ,[idOperacion] ) AS tmpPRG
INNER JOIN (
SELECT tblDctosOrdenesDetalle.idLocalOrigen,
       tblDctosOrdenesDetalle.idTipoOrdenOrigen,
       tblDctosOrdenesDetalle.idOrdenOrigen,
       tblDctosOrdenesDetalle.itemPadre,
       tblDctosOrdenesDetalle.idOperacion,
       SUM(cantidad * (-1)) AS pesoTerminado,
       0 AS cantidadTerminada
FROM tblDctosOrdenesDetalle
where idordenorigen = 7771
and cantidad<0
GROUP BY tblDctosOrdenesDetalle.idLocalOrigen,
       tblDctosOrdenesDetalle.idTipoOrdenOrigen,
       tblDctosOrdenesDetalle.idOrdenOrigen,
       tblDctosOrdenesDetalle.itemPadre,
       tblDctosOrdenesDetalle.idOperacion ) AS tmpORD
ON tmpPRG.idLocal = tmpORD.idLocalOrigen
AND tmpPRG.idTipoOrden = tmpORD.idTipoOrdenOrigen
AND tmpPRG.idOrden = tmpORD.idOrdenOrigen

---
SELECT [idLocal]
      ,[idTipoOrden]
      ,[idOrden]
      ,[itemPadre]
      ,[idOperacion]
      ,SUM([cantidadTerminada]) 
          AS cantidadTerminada
      ,SUM([pesoTerminado]) 
              AS pesoTerminado
INTO tmpTerminado
FROM [tblDctosOrdenesProgreso]
GROUP BY [idLocal]
      ,[idTipoOrden]
      ,[idOrden]
      ,[itemPadre]      
      ,[idOperacion] 

-- actualizar produccion
UPDATE    tblDctosOrdenesDetalle
SET       cantidadTerminada = 0,
          pesoTerminado     = cantidad
WHERE tblDctosOrdenesDetalle.idTipoOrden = 11

UPDATE    tblDctosOrdenesDetalle
SET       cantidadTerminada     = 
                       tmpTerminado.cantidadTerminada
FROM      tblDctosOrdenesDetalle
INNER JOIN tmpTerminado
ON tblDctosOrdenesDetalle.idLocalOrigen      = 
                             tmpTerminado.idLocal
AND tblDctosOrdenesDetalle.idTipoOrdenOrigen = 
                         tmpTerminado.idTipoOrden
AND tblDctosOrdenesDetalle.idOrdenOrigen     = 
                             tmpTerminado.idOrden
AND tblDctosOrdenesDetalle.itemPadre         = 
                           tmpTerminado.itemPadre
AND tblDctosOrdenesDetalle.idOperacion       = 
                         tmpTerminado.idOperacion

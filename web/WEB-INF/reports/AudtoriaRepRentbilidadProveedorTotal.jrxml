<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="report name" pageWidth="595" pageHeight="842" columnWidth="535" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<parameter name="p_nombreLocal" class="java.lang.String"/>
	<parameter name="p_titulo" class="java.lang.String"/>
	<parameter name="p_nit" class="java.lang.String"/>
	<parameter name="p_idLocal" class="java.lang.Integer"/>
	<parameter name="p_fechaInicialSqlServer" class="java.lang.String"/>
	<parameter name="p_fechaFinalSqlServer" class="java.lang.String"/>
	<parameter name="p_idTipoOrdenINI" class="java.lang.Integer"/>
	<parameter name="p_idTipoOrdenFIN" class="java.lang.Integer"/>
	<queryString>
		<![CDATA[SELECT     SUM(tblDctosOrdenesDetalle.CANTIDAD *
               tblDctosOrdenesDetalle.VRVENTAUNITARIO)
                                 AS vrBase,
           SUM(tblDctosOrdenesDetalle.CANTIDAD *
               tblDctosOrdenesDetalle.vrCostoIND)
                                 AS vrCostoIND,
           (CASE
           WHEN (SUM(tblDctosOrdenesDetalle.CANTIDAD *
               tblDctosOrdenesDetalle.VRVENTAUNITARIO)) = 0
           THEN 0
           ELSE (SUM(tblDctosOrdenesDetalle.CANTIDAD *
               tblDctosOrdenesDetalle.VRVENTAUNITARIO)-
            SUM(tblDctosOrdenesDetalle.CANTIDAD *
               tblDctosOrdenesDetalle.vrCostoIND))/
           (SUM(tblDctosOrdenesDetalle.CANTIDAD *
               tblDctosOrdenesDetalle.VRVENTAUNITARIO))
           END)   AS margenPRV
FROM       tblDctos
INNER JOIN tblDctosOrdenesDetalle
ON tblDctos.IDLOCAL =
        tblDctosOrdenesDetalle.IDLOCAL
AND tblDctos.IDTIPOORDEN =
        tblDctosOrdenesDetalle.IDTIPOORDEN
AND tblDctos.IDORDEN =
        tblDctosOrdenesDetalle.IDORDEN
INNER JOIN ( SELECT     tblDctosOrdenesDetalle.idLocal,
           tblDctos.idCliente,
		   tblDctosOrdenesDetalle.idPlu
 FROM       tblDctos
 INNER JOIN tblDctosOrdenesDetalle
 ON tblDctos.IDLOCAL      =
           tblDctosOrdenesDetalle.IDLOCAL
 AND tblDctos.IDTIPOORDEN =
       tblDctosOrdenesDetalle.IDTIPOORDEN
 AND tblDctos.IDORDEN     =
           tblDctosOrdenesDetalle.IDORDEN
 INNER JOIN tblTerceros
 ON tblTerceros.idCliente  =
        tblDctos.idCliente
 WHERE tblDctos.idLocal     = $P{p_idLocal}
 AND   tblDctos.idTipoOrden IN (1,21)
 AND   tblDctos.fechaDcto
       BETWEEN $P{p_fechaInicialSqlServer}
       AND $P{p_fechaFinalSqlServer}
 GROUP BY tblDctosOrdenesDetalle.idLocal,
           tblDctos.idCliente,
		   tblDctosOrdenesDetalle.idPlu)
		   AS tmpPRV
ON tblDctos.IDLOCAL   =   tmpPRV.IDLOCAL
AND tblDctosOrdenesDetalle.idPlu  =   tmpPRV.idPlu
 WHERE tblDctos.idLocal     = $P{p_idLocal}
 AND   ( tblDctos.idTipoOrden = $P{p_idTipoOrdenINI}
         OR tblDctos.idTipoOrden = $P{p_idTipoOrdenFIN})
 AND   tblDctos.fechaDcto
        BETWEEN $P{p_fechaInicialSqlServer}
         AND $P{p_fechaFinalSqlServer}]]>
	</queryString>
	<field name="vrBase" class="java.lang.Double"/>
	<field name="vrCostoIND" class="java.lang.Double"/>
	<field name="margenPRV" class="java.lang.Double"/>
	<background>
		<band/>
	</background>
	<title>
		<band/>
	</title>
	<pageHeader>
		<band/>
	</pageHeader>
	<columnHeader>
		<band/>
	</columnHeader>
	<detail>
		<band height="10">
			<staticText>
				<reportElement x="20" y="0" width="120" height="10"/>
				<textElement textAlignment="Left">
					<font fontName="Verdana" size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[TOTALES]]></text>
			</staticText>
			<textField pattern="#,##0.00 %">
				<reportElement x="326" y="0" width="35" height="10"/>
				<textElement textAlignment="Right">
					<font size="6"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{margenPRV}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="184" y="0" width="46" height="10"/>
				<textElement textAlignment="Right">
					<font size="6"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{vrBase}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="259" y="0" width="40" height="10"/>
				<textElement textAlignment="Right">
					<font size="6"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{vrCostoIND}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band/>
	</columnFooter>
	<pageFooter>
		<band/>
	</pageFooter>
	<summary>
		<band/>
	</summary>
</jasperReport>

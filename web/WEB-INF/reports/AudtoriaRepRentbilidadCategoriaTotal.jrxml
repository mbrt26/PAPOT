<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="report name" pageWidth="595" pageHeight="842" columnWidth="535" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<parameter name="p_nombreLocal" class="java.lang.String"/>
	<parameter name="p_titulo" class="java.lang.String"/>
	<parameter name="p_nit" class="java.lang.String"/>
	<parameter name="p_idLocal" class="java.lang.Integer"/>
	<parameter name="p_fechaInicialSqlServer" class="java.lang.String"/>
	<parameter name="p_fechaFinalSqlServer" class="java.lang.String"/>
	<parameter name="p_idTipoOrdenINI" class="java.lang.Integer"/>
	<parameter name="p_idTipoOrdenFIN" class="java.lang.Integer"/>
	<parameter name="p_indicadorINI" class="java.lang.Integer"/>
	<parameter name="p_indicadorFIN" class="java.lang.Integer"/>
	<queryString>
		<![CDATA[SELECT
                SUM(tmpVTA.vrVentaSinIva)
				AS vrVentaSinIva,
                        SUM(tmpVTA.vrIva)
				AS vrVentaIva,
                        SUM(tmpVTA.vrCostoIND)
				AS vrCostoIND,
			    (CASE
				 WHEN SUM(tmpVTA.vrVentaSinIva) = 0
				 THEN 0
				 ELSE (SUM(tmpVTA.vrVentaSinIva) - SUM(tmpVTA.vrCostoIND))/
			           SUM(tmpVTA.vrVentaSinIva)
			     END)   AS margenMarca
				FROM    tblCategorias
                INNER JOIN tblPlus
                ON tblCategorias.idLinea      =
                                      tblPlus.idLinea
                AND tblCategorias.IdCategoria =
                                  tblPlus.idCategoria
                INNER JOIN tblMarcas
                ON tblPlus.idMarca            =
                                     tblMarcas.idMarca
                INNER JOIN (SELECT tmpMVT.idPlu,
                SUM((CASE WHEN
                             tmpMVT.indicador = 1
                     THEN    tmpMVT.vrVentaSinIva
                     ELSE    ( tmpMVT.vrVentaSinIva +
                               tmpMVT.vrIva )
                     END)) AS  vrVentaSinIva,
                SUM((CASE WHEN
                               tmpMVT.indicador = 1
                     THEN      tmpMVT.vrIva
                     ELSE    0
                     END)) AS vrIva,
                 SUM(tmpMVT.vrCostoIND)    AS vrCostoIND,
                 SUM(tmpMVT.cantidad)    AS cantidad
                 FROM
                (SELECT tblDctos.indicador,
                       tblPlusCombo.IDPLU
                       ,SUM(tblDctosOrdenesDetalle.CANTIDAD *
                            tblPlusCombo.cantidad) AS cantidad
                       ,SUM(tblDctosOrdenesDetalle.CANTIDAD *
                            tblPlusCombo.cantidad         *
                           (tblDctosOrdenesDetalle.vrVentaUnitario   -
                            tblDctosOrdenesDetalle.vrImpoconsumo)    /
                  ((1 + (tblDctosOrdenesDetalle.porcentajeIva /100)) *
                 (1 + (tblDctosOrdenesDetalle.vrDsctoPie /100 ) ) *
                 (1 + (tblDctosOrdenesDetalle.porcentajeDscto /100 ))))
                                                      AS vrVentaSinIva
                       ,SUM( (tblDctosOrdenesDetalle.CANTIDAD *
                            tblPlusCombo.cantidad           *
                           (tblDctosOrdenesDetalle.vrVentaUnitario -
                            tblDctosOrdenesDetalle.vrImpoconsumo)) *
                    (1 - tblDctosOrdenesDetalle.porcentajeDscto / 100) *
                        (1 - tblDctosOrdenesDetalle.vrDsctoPie / 100))
                                                     AS vrVentaConIva
                       ,SUM( (tblDctosOrdenesDetalle.CANTIDAD *
                            tblPlusCombo.cantidad           *
                           (tblDctosOrdenesDetalle.vrVentaUnitario -
                            tblDctosOrdenesDetalle.vrImpoconsumo)) *
                   (1 - tblDctosOrdenesDetalle.porcentajeDscto / 100) *
                   (1 - tblDctosOrdenesDetalle.vrDsctoPie / 100))     -
                       SUM(tblDctosOrdenesDetalle.CANTIDAD *
                            tblPlusCombo.cantidad         *
                           (tblDctosOrdenesDetalle.vrVentaUnitario   -
                            tblDctosOrdenesDetalle.vrImpoconsumo)    /
                    ((1 + (tblDctosOrdenesDetalle.porcentajeIva /100)) *
                    (1 + (tblDctosOrdenesDetalle.vrDsctoPie /100 ) ) *
                 (1 + (tblDctosOrdenesDetalle.porcentajeDscto /100 ))))
                                                               AS vrIva
                       ,SUM( (tblDctosOrdenesDetalle.CANTIDAD *
                            tblPlusCombo.cantidad             *
                              tblDctosOrdenesDetalle.vrCosto )      /
                  (1 + tblDctosOrdenesDetalle.porcentajeIva / 100))
                                                   AS vrCostoSinIva
                       ,SUM(  tblDctosOrdenesDetalle.CANTIDAD *
                            tblPlusCombo.cantidad            *
                                     tblDctosOrdenesDetalle.vrCosto)
                                                     AS vrCostoConIva
                       ,SUM(  tblDctosOrdenesDetalle.CANTIDAD *
                            tblPlusCombo.cantidad            *
                                  tblDctosOrdenesDetalle.vrCostoIND)
                                                         AS vrCostoIND
                FROM   tblDctos
                INNER JOIN tblDctosOrdenesDetalle
                ON  tblDctos.IDLOCAL     =
                       tblDctosOrdenesDetalle.IDLOCAL
                AND tblDctos.IDTIPOORDEN =
                   tblDctosOrdenesDetalle.IDTIPOORDEN
                AND tblDctos.IDORDEN     =
                       tblDctosOrdenesDetalle.IDORDEN
                INNER JOIN tblPlusCombo
                ON tblDctosOrdenesDetalle.IDPLU                    =
                              tblPlusCombo.idPluCombo
                  WHERE (tblDctos.IDLOCAL   =  $P{p_idLocal}
                    AND ( tblDctos.idTipoOrden  = $P{p_idTipoOrdenINI}
                           OR tblDctos.idTipoOrden = $P{p_idTipoOrdenFIN})
                   AND tblDctos.fechaDcto BETWEEN $P{p_fechaInicialSqlServer}
                                          AND $P{p_fechaFinalSqlServer}
                   AND tblDctos.indicador BETWEEN $P{p_indicadorINI}
                                           AND $P{p_indicadorFIN})
                GROUP BY tblDctos.indicador,
						 tblPlusCombo.IDPLU
                UNION
                SELECT tblDctos.indicador,
                       tblDctosOrdenesDetalle.IDPLU
                       ,SUM(tblDctosOrdenesDetalle.CANTIDAD)
                                                 AS cantidad
                       ,SUM(tblDctosOrdenesDetalle.cantidad          *
                           (tblDctosOrdenesDetalle.vrVentaUnitario   -
                            tblDctosOrdenesDetalle.vrImpoconsumo)    /
                    ((1 + (tblDctosOrdenesDetalle.porcentajeIva /100)) *
                    (1 + (tblDctosOrdenesDetalle.vrDsctoPie /100 ) ) *
                  (1 + (tblDctosOrdenesDetalle.porcentajeDscto /100 ))))
                                                      AS vrVentaSinIva
                       ,SUM( (tblDctosOrdenesDetalle.CANTIDAD       *
                           (tblDctosOrdenesDetalle.vrVentaUnitario -
                            tblDctosOrdenesDetalle.vrImpoconsumo)) *
                   (1 - tblDctosOrdenesDetalle.porcentajeDscto / 100) *
                          (1 - tblDctosOrdenesDetalle.vrDsctoPie / 100))
                                                     AS vrVentaConIva
                       ,SUM( (tblDctosOrdenesDetalle.CANTIDAD      *
                           (tblDctosOrdenesDetalle.vrVentaUnitario -
                            tblDctosOrdenesDetalle.vrImpoconsumo)) *
                  (1 - tblDctosOrdenesDetalle.porcentajeDscto / 100) *
                  (1 - tblDctosOrdenesDetalle.vrDsctoPie / 100))     -
                        SUM(tblDctosOrdenesDetalle.cantidad         *
                           (tblDctosOrdenesDetalle.vrVentaUnitario   -
                            tblDctosOrdenesDetalle.vrImpoconsumo)    /
                  ((1 + (tblDctosOrdenesDetalle.porcentajeIva /100)) *
                      (1 + (tblDctosOrdenesDetalle.vrDsctoPie /100 ) ) *
                 (1 + (tblDctosOrdenesDetalle.porcentajeDscto /100 ))))
                                                               AS vrIva
                       ,SUM( (tblDctosOrdenesDetalle.CANTIDAD       *
                              tblDctosOrdenesDetalle.vrCosto )      /
                      (1 + tblDctosOrdenesDetalle.porcentajeIva / 100))
                                                     AS vrCostoSinIva
                       ,SUM(  tblDctosOrdenesDetalle.CANTIDAD    *
                                     tblDctosOrdenesDetalle.vrCosto)
                                                     AS vrCostoConIva
                       ,SUM(  tblDctosOrdenesDetalle.CANTIDAD    *
                                  tblDctosOrdenesDetalle.vrCostoIND)
                                                       AS vrCostoIND
                FROM   tblDctos
                INNER JOIN tblDctosOrdenesDetalle
                ON  tblDctos.IDLOCAL     =
                    tblDctosOrdenesDetalle.IDLOCAL
                AND tblDctos.IDTIPOORDEN =
                    tblDctosOrdenesDetalle.IDTIPOORDEN
                AND tblDctos.IDORDEN     =
                    tblDctosOrdenesDetalle.IDORDEN
                   WHERE (tblDctos.IDLOCAL   = $P{p_idLocal}
				   AND ( tblDctos.idTipoOrden  = $P{p_idTipoOrdenINI}
                           OR tblDctos.idTipoOrden = $P{p_idTipoOrdenFIN})
                   AND tblDctos.fechaDcto BETWEEN $P{p_fechaInicialSqlServer}
                                           AND $P{p_fechaFinalSqlServer}
                  AND tblDctos.indicador BETWEEN $P{p_indicadorINI}
                                           AND $P{p_indicadorFIN}
                AND  tblDctos.IDLOCAL     =
                                          tblDctosOrdenesDetalle.IDLOCAL
                AND  tblDctos.IDTIPOORDEN =
                                     tblDctosOrdenesDetalle.IDTIPOORDEN
                AND  tblDctos.IDORDEN     =
                                         tblDctosOrdenesDetalle.IDORDEN
                AND tblDctosOrdenesDetalle.idTipo            = 1 )
                GROUP BY tblDctos.indicador,
                         tblDctosOrdenesDetalle.IDPLU) AS tmpMVT
                GROUP BY tmpMVT.idPlu) AS tmpVTA
                ON tmpVTA.idPlu       = tblPlus.idPlu]]>
	</queryString>
	<field name="vrVentaSinIva" class="java.lang.Double"/>
	<field name="vrVentaIva" class="java.lang.Double"/>
	<field name="vrCostoIND" class="java.lang.Double"/>
	<field name="margenMarca" class="java.lang.Double"/>
	<background>
		<band/>
	</background>
	<title>
		<band/>
	</title>
	<pageHeader>
		<band/>
	</pageHeader>
	<columnHeader>
		<band/>
	</columnHeader>
	<detail>
		<band height="10">
			<textField pattern="#,##0">
				<reportElement x="192" y="0" width="67" height="10"/>
				<textElement textAlignment="Right">
					<font size="6"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{vrVentaIva}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00 %">
				<reportElement x="438" y="0" width="66" height="10"/>
				<textElement textAlignment="Right">
					<font size="6"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{margenMarca}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="283" y="0" width="63" height="10"/>
				<textElement textAlignment="Right">
					<font size="6"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{vrVentaSinIva}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="371" y="0" width="40" height="10"/>
				<textElement textAlignment="Right">
					<font size="6"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{vrCostoIND}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="11" y="0" width="140" height="10"/>
				<textElement textAlignment="Left">
					<font fontName="Verdana" size="8" isBold="true"/>
				</textElement>
				<text><![CDATA[TOTALES]]></text>
			</staticText>
		</band>
	</detail>
	<columnFooter>
		<band/>
	</columnFooter>
	<pageFooter>
		<band/>
	</pageFooter>
	<summary>
		<band/>
	</summary>
</jasperReport>
